<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Space Race - Board Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGAXmqmbn4fV47eNXa8PSP4N_hIWxmsuE",
            authDomain: "space-race-game-d20ad.firebaseapp.com",
            databaseURL: "https://space-race-game-d20ad-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "space-race-game-d20ad",
            storageBucket: "space-race-game-d20ad.firebasestorage.app",
            messagingSenderId: "691384338211",
            appId: "1:691384338211:web:f17b92c8ff574daa012e96",
            measurementId: "G-0YV3DXD5RM"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, update, get, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Game State
        window.GameState = {
            currentScreen: 'home',
            playerName: '',
            playerId: '',
            roomCode: '',
            isHost: false,
            currentRoom: null,
            roomListener: null,
            animating: false
        };

        // Planet/Space Data with Images (using emoji as fallback, you can replace with actual image URLs)
        const SPACES = [
            { id: 1, name: '‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', icon: '‚òÄÔ∏è', hp: 0, color: '#FDB813' },
            { id: 2, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 3, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 4, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 5, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 6, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 7, name: '‡∏û‡∏∏‡∏ò', icon: 'üî•', hp: -10, color: '#EE6C4D' },
            { id: 8, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 9, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 10, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 11, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 12, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 13, name: '‡∏®‡∏∏‡∏Å‡∏£‡πå', icon: 'üåã', hp: -20, color: '#DC2626' },
            { id: 14, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 15, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 16, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 17, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 18, name: '‡πÇ‡∏•‡∏Å', icon: 'üåç', hp: 50, color: '#10B981' },
            { id: 19, name: '‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', icon: 'üåô', hp: 25, color: '#93C5FD' },
            { id: 20, name: 'ISS', icon: 'üõ∞Ô∏è', hp: 0, color: '#6366F1' },
            { id: 21, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 22, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 23, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 24, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 25, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 26, name: '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', icon: 'üî¥', hp: -5, color: '#EF4444' },
            { id: 27, name: 'Rover', icon: 'ü§ñ', hp: 10, color: '#8B5CF6' },
            { id: 28, name: 'Phobos', icon: 'üî¥', hp: 10, color: '#F97316' },
            { id: 29, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 30, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 31, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 32, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 33, name: 'Asteroid', icon: 'üåü', hp: -25, color: '#78716C' },
            { id: 34, name: 'Asteroid', icon: 'üåü', hp: -25, color: '#78716C' },
            { id: 35, name: 'Asteroid', icon: 'üåü', hp: -25, color: '#78716C' },
            { id: 36, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 37, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 38, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 39, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 40, name: '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', icon: 'ü™ê', hp: 0, color: '#F59E0B' },
            { id: 41, name: 'Europa', icon: 'üåä', hp: 0, color: '#06B6D4' },
            { id: 42, name: 'Io', icon: 'üî•', hp: -15, color: '#DC2626' },
            { id: 43, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 44, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 45, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 46, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 47, name: '‡πÄ‡∏™‡∏≤‡∏£‡πå', icon: 'üíç', hp: 0, color: '#FBBF24' },
            { id: 48, name: 'Titan', icon: 'üåï', hp: 0, color: '#A78BFA' },
            { id: 49, name: 'Enceladus', icon: '‚ùÑÔ∏è', hp: -10, color: '#60A5FA' },
            { id: 50, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 51, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 52, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 53, name: '‡∏¢‡∏π‡πÄ‡∏£‡∏ô‡∏±‡∏™', icon: 'üíé', hp: 0, color: '#06B6D4' },
            { id: 54, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 55, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 56, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 57, name: '‡πÄ‡∏ô‡∏õ‡∏à‡∏π‡∏ô', icon: 'üîµ', hp: -15, color: '#3B82F6' },
            { id: 58, name: 'Triton', icon: 'üîµ', hp: -10, color: '#60A5FA' },
            { id: 59, name: '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', icon: '‚≠ê', hp: 0, color: '#1e293b' },
            { id: 60, name: '‡∏û‡∏•‡∏π‡πÇ‡∏ï', icon: '‚ùÑÔ∏è', hp: 0, color: '#9333EA' }
        ];

        // Items with full functionality
        const ITEMS = {
            healing: [
                { id: 'fuel', name: '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á', icon: 'üöÄ', effect: 'move', value: 3 },
                { id: 'solar', name: '‡∏û‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏á', icon: '‚ö°', effect: 'heal', value: 30 },
                { id: 'shield', name: '‡πÇ‡∏•‡πà', icon: 'üõ°Ô∏è', effect: 'shield', value: 1 },
                { id: 'medicine', name: '‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤', icon: 'üíä', effect: 'heal', value: 40 },
                { id: 'hyperdrive', name: '‡πÑ‡∏Æ‡πÄ‡∏õ‡∏≠‡∏£‡πå', icon: '‚è©', effect: 'move', value: 5 },
                { id: 'crystal', name: '‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•', icon: 'üíé', effect: 'heal', value: 60 }
            ],
            attack: [
                { id: 'meteor', name: '‡∏î‡∏≤‡∏ß‡∏ï‡∏Å', icon: '‚òÑÔ∏è', effect: 'damage', value: 20 },
                { id: 'freeze', name: '‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á', icon: '‚ùÑÔ∏è', effect: 'freeze', value: 1 },
                { id: 'blackhole', name: '‡∏´‡∏•‡∏∏‡∏°‡∏î‡∏≥', icon: 'üåë', effect: 'back', value: 5 },
                { id: 'bomb', name: '‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î', icon: 'üß®', effect: 'damage', value: 30 }
            ]
        };

        // Utility Functions
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function generatePlayerId() {
            return 'P' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function getRandomItem() {
            const allItems = [...ITEMS.healing, ...ITEMS.attack];
            return allItems[Math.floor(Math.random() * allItems.length)];
        }

        function getPlayerColor(index) {
            const colors = ['#EF4444', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899'];
            return colors[index % colors.length];
        }

        // Show Screen
        window.showScreen = function(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${screenName}-screen`)?.classList.remove('hidden');
            GameState.currentScreen = screenName;
        };

        // Create Room
        window.createRoom = async function() {
            const playerName = document.getElementById('player-name-create').value.trim();
            if (!playerName) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', 'error');
                return;
            }

            const roomCode = generateRoomCode();
            const playerId = generatePlayerId();
            
            GameState.playerName = playerName;
            GameState.playerId = playerId;
            GameState.roomCode = roomCode;
            GameState.isHost = true;

            const roomData = {
                code: roomCode,
                host: playerId,
                status: 'waiting',
                created: Date.now(),
                players: {
                    [playerId]: {
                        name: playerName,
                        position: 1,
                        hp: 100,
                        maxHp: 100,
                        items: [],
                        status: 'active',
                        isHost: true,
                        color: getPlayerColor(0),
                        shield: false,
                        frozen: false,
                        joined: Date.now()
                    }
                },
                game: {
                    started: false,
                    currentTurn: 0,
                    turnPlayerId: playerId,
                    round: 1,
                    lastDice: 0,
                    winner: null
                }
            };

            try {
                await set(ref(database, `rooms/${roomCode}`), roomData);
                setupDisconnect(roomCode, playerId);
                listenToRoom(roomCode);
                showScreen('lobby');
                showMessage('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (error) {
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        };

        // Join Room
        window.joinRoom = async function() {
            const playerName = document.getElementById('player-name-join').value.trim();
            const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
            
            if (!playerName || !roomCode) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
                return;
            }

            try {
                const snapshot = await get(ref(database, `rooms/${roomCode}`));
                if (!snapshot.exists()) {
                    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ', 'error');
                    return;
                }

                const roomData = snapshot.val();
                if (roomData.status === 'playing') {
                    showMessage('‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß', 'error');
                    return;
                }

                const playerCount = Object.keys(roomData.players || {}).length;
                if (playerCount >= 4) {
                    showMessage('‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏° (4 ‡∏Ñ‡∏ô)', 'error');
                    return;
                }

                const playerId = generatePlayerId();
                GameState.playerName = playerName;
                GameState.playerId = playerId;
                GameState.roomCode = roomCode;
                GameState.isHost = false;

                await update(ref(database, `rooms/${roomCode}/players/${playerId}`), {
                    name: playerName,
                    position: 1,
                    hp: 100,
                    maxHp: 100,
                    items: [],
                    status: 'active',
                    isHost: false,
                    color: getPlayerColor(playerCount),
                    shield: false,
                    frozen: false,
                    joined: Date.now()
                });

                setupDisconnect(roomCode, playerId);
                listenToRoom(roomCode);
                showScreen('lobby');
                showMessage('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (error) {
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        };

        // Setup disconnect handler
        function setupDisconnect(roomCode, playerId) {
            const playerRef = ref(database, `rooms/${roomCode}/players/${playerId}`);
            onDisconnect(playerRef).remove();
        }

        // Listen to Room
        function listenToRoom(roomCode) {
            if (GameState.roomListener) {
                GameState.roomListener();
            }

            const roomRef = ref(database, `rooms/${roomCode}`);
            GameState.roomListener = onValue(roomRef, (snapshot) => {
                if (!snapshot.exists()) {
                    showMessage('‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î', 'error');
                    leaveRoom();
                    return;
                }

                GameState.currentRoom = snapshot.val();
                console.log('Room updated:', GameState.currentRoom);
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ lobby ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°
                if (GameState.currentRoom.status === 'playing' && GameState.currentScreen === 'lobby') {
                    console.log('Game started! Moving to game screen');
                    showScreen('game');
                    showMessage('‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                }
                
                if (GameState.currentScreen === 'lobby') {
                    updateLobby();
                } else if (GameState.currentScreen === 'game') {
                    updateGame();
                }
            });
        }

        // Start Game (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Å‡∏î‡πÑ‡∏î‡πâ)
        window.startGame = async function() {
            console.log('=== START GAME CLICKED ===');
            console.log('Room Code:', GameState.roomCode);
            console.log('Player ID:', GameState.playerId);
            console.log('Current Room:', GameState.currentRoom);
            
            const players = Object.keys(GameState.currentRoom.players);
            console.log('Players:', players);
            
            if (players.length < 2) {
                showMessage('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 2 ‡∏Ñ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', 'error');
                return;
            }
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢
            if (GameState.currentRoom.status === 'playing') {
                console.log('Game already playing, going to game screen');
                showScreen('game');
                return;
            }

            try {
                console.log('Updating status to playing...');
                await update(ref(database, `rooms/${GameState.roomCode}`), {
                    status: 'playing'
                });
                console.log('‚úÖ Status updated');

                console.log('Updating game state...');
                await update(ref(database, `rooms/${GameState.roomCode}/game`), {
                    started: true,
                    currentTurn: 0,
                    turnPlayerId: players[0],
                    round: 1
                });
                console.log('‚úÖ Game state updated');

                console.log('Changing to game screen...');
                showScreen('game');
                console.log('‚úÖ Screen changed');
                
                showMessage('‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            } catch (error) {
                console.error('‚ùå Error:', error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        };

        // Roll Dice with animation
        window.rollDice = async function() {
            if (GameState.animating) return;
            
            if (!isMyTurn()) {
                showMessage('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì', 'error');
                return;
            }

            const player = GameState.currentRoom.players[GameState.playerId];
            
            if (player.frozen) {
                await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                    frozen: false
                });
                showMessage('‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á! ‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≤‡∏ô‡∏µ‡πâ', 'error');
                nextTurn();
                return;
            }

            if (player.status === 'resting') {
                showMessage('‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô', 'error');
                return;
            }

            GameState.animating = true;
            const btn = document.getElementById('roll-btn');
            btn.disabled = true;
            btn.textContent = 'üé≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≠‡∏¢...';

            // Animate dice
            await animateDice();

            const dice = Math.floor(Math.random() * 6) + 1;
            const currentPos = player.position;
            const newPos = Math.min(currentPos + dice, 60);

            await update(ref(database, `rooms/${GameState.roomCode}/game`), {
                lastDice: dice
            });

            showMessage(`‡∏ó‡∏≠‡∏¢‡πÑ‡∏î‡πâ ${dice}! üé≤`, 'info');

            // Animate movement
            await animateMovement(currentPos, newPos);

            await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                position: newPos
            });

            await applySpaceEffect(newPos);

            // Give random item
            const item = getRandomItem();
            const currentItems = player.items || [];
            currentItems.push(item);
            await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                items: currentItems
            });

            showMessage(`‡πÑ‡∏î‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°: ${item.icon} ${item.name}`, 'success');

            setTimeout(() => {
                nextTurn();
                btn.disabled = false;
                btn.textContent = 'üé≤ ‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤';
                GameState.animating = false;
            }, 1500);
        };

        // Animate dice roll
        async function animateDice() {
            return new Promise(resolve => {
                let count = 0;
                const interval = setInterval(() => {
                    const dice = Math.floor(Math.random() * 6) + 1;
                    document.getElementById('dice-display').textContent = dice;
                    count++;
                    if (count >= 10) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 100);
            });
        }

        // Animate movement
        async function animateMovement(from, to) {
            return new Promise(resolve => {
                let current = from;
                const interval = setInterval(() => {
                    current++;
                    highlightSpace(current);
                    if (current >= to) {
                        clearInterval(interval);
                        setTimeout(resolve, 300);
                    }
                }, 300);
            });
        }

        function highlightSpace(pos) {
            document.querySelectorAll('.space-cell').forEach(cell => {
                cell.classList.remove('highlight');
            });
            const cell = document.querySelector(`[data-position="${pos}"]`);
            if (cell) {
                cell.classList.add('highlight');
            }
        }

        // Apply Space Effect
        async function applySpaceEffect(position) {
            const space = SPACES[position - 1];
            if (!space || space.hp === 0) return;

            const player = GameState.currentRoom.players[GameState.playerId];
            
            if (player.shield && space.hp < 0) {
                await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                    shield: false
                });
                showMessage('‡πÇ‡∏•‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢!', 'success');
                return;
            }

            const newHp = Math.max(0, Math.min(player.hp + space.hp, 100));
            
            await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                hp: newHp
            });

            if (space.hp > 0) {
                showMessage(`${space.icon} ${space.name}: HP +${space.hp}`, 'success');
            } else {
                showMessage(`${space.icon} ${space.name}: HP ${space.hp}`, 'error');
            }

            if (newHp === 0) {
                await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                    status: 'resting',
                    restTurns: 3
                });
                showMessage('‚ù§Ô∏è‚Äçü©π HP ‡∏´‡∏°‡∏î! ‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô 3 ‡∏ï‡∏≤', 'error');
            }

            if (position === 60) {
                await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                    status: 'finished',
                    finishTime: Date.now()
                });
                await update(ref(database, `rooms/${GameState.roomCode}/game`), {
                    winner: GameState.playerId
                });
                showMessage('üèÜ ‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏∂‡∏á‡∏û‡∏•‡∏π‡πÇ‡∏ï‡∏Å‡πà‡∏≠‡∏ô!', 'success');
                setTimeout(() => showWinnerScreen(), 2000);
            }
        }

        // Use Item
        window.useItem = async function(itemIndex) {
            if (!isMyTurn()) {
                showMessage('‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', 'error');
                return;
            }

            const player = GameState.currentRoom.players[GameState.playerId];
            const item = player.items[itemIndex];
            
            if (!item) return;

            const players = GameState.currentRoom.players;
            const playerIds = Object.keys(players);

            switch(item.effect) {
                case 'heal':
                    const newHp = Math.min(player.hp + item.value, 100);
                    await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                        hp: newHp
                    });
                    showMessage(`‡∏ü‡∏∑‡πâ‡∏ô HP +${item.value}`, 'success');
                    break;

                case 'move':
                    const newPos = Math.min(player.position + item.value, 60);
                    await animateMovement(player.position, newPos);
                    await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                        position: newPos
                    });
                    await applySpaceEffect(newPos);
                    showMessage(`‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ +${item.value} ‡∏ä‡πà‡∏≠‡∏á`, 'success');
                    break;

                case 'shield':
                    await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                        shield: true
                    });
                    showMessage('‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏•‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô!', 'success');
                    break;

                case 'damage':
                case 'freeze':
                case 'back':
                    // Show target selection
                    showTargetSelection(item, itemIndex);
                    return; // Don't remove item yet

                default:
                    showMessage(`‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°: ${item.icon} ${item.name}`, 'info');
            }

            // Remove used item
            const updatedItems = [...player.items];
            updatedItems.splice(itemIndex, 1);
            await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                items: updatedItems
            });
        };

        // Show target selection for attack items
        function showTargetSelection(item, itemIndex) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
            
            const players = GameState.currentRoom.players;
            const playerIds = Object.keys(players).filter(id => id !== GameState.playerId);

            modal.innerHTML = `
                <div class="bg-gray-800 rounded-2xl p-8 max-w-md">
                    <h3 class="text-2xl font-bold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
                    <p class="text-gray-300 mb-6">‡πÉ‡∏ä‡πâ ${item.icon} ${item.name}</p>
                    <div class="space-y-3">
                        ${playerIds.map(id => `
                            <button onclick="attackPlayer('${id}', ${itemIndex}, '${item.effect}', ${item.value})" 
                                    class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 p-4 rounded-lg transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full" style="background: ${players[id].color}"></div>
                                    <div class="text-left">
                                        <div class="font-bold">${players[id].name}</div>
                                        <div class="text-sm">HP: ${players[id].hp}</div>
                                    </div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-lg">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Attack player
        window.attackPlayer = async function(targetId, itemIndex, effect, value) {
            const target = GameState.currentRoom.players[targetId];
            const player = GameState.currentRoom.players[GameState.playerId];

            document.querySelector('.fixed')?.remove();

            switch(effect) {
                case 'damage':
                    if (target.shield) {
                        await update(ref(database, `rooms/${GameState.roomCode}/players/${targetId}`), {
                            shield: false
                        });
                        showMessage(`${target.name} ‡πÉ‡∏ä‡πâ‡πÇ‡∏•‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô!`, 'info');
                    } else {
                        const newHp = Math.max(0, target.hp - value);
                        await update(ref(database, `rooms/${GameState.roomCode}/players/${targetId}`), {
                            hp: newHp
                        });
                        showMessage(`‡πÇ‡∏à‡∏°‡∏ï‡∏µ ${target.name} -${value} HP`, 'success');
                        
                        if (newHp === 0) {
                            await update(ref(database, `rooms/${GameState.roomCode}/players/${targetId}`), {
                                status: 'resting',
                                restTurns: 3
                            });
                        }
                    }
                    break;

                case 'freeze':
                    await update(ref(database, `rooms/${GameState.roomCode}/players/${targetId}`), {
                        frozen: true
                    });
                    showMessage(`‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á ${target.name}! ‡∏û‡∏•‡∏≤‡∏î 1 ‡∏ï‡∏≤`, 'success');
                    break;

                case 'back':
                    const newPos = Math.max(1, target.position - value);
                    await update(ref(database, `rooms/${GameState.roomCode}/players/${targetId}`), {
                        position: newPos
                    });
                    showMessage(`‡∏ú‡∏•‡∏±‡∏Å ${target.name} ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á ${value} ‡∏ä‡πà‡∏≠‡∏á`, 'success');
                    break;
            }

            // Remove used item
            const updatedItems = [...player.items];
            updatedItems.splice(itemIndex, 1);
            await update(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`), {
                items: updatedItems
            });
        };

        // Next Turn
        async function nextTurn() {
            const game = GameState.currentRoom.game;
            const players = Object.keys(GameState.currentRoom.players);
            let nextIndex = (game.currentTurn + 1) % players.length;

            // Check resting players
            let nextPlayer = GameState.currentRoom.players[players[nextIndex]];
            while (nextPlayer.status === 'resting' || nextPlayer.status === 'finished') {
                if (nextPlayer.status === 'resting' && nextPlayer.restTurns > 0) {
                    const newRestTurns = nextPlayer.restTurns - 1;
                    
                    if (newRestTurns === 0) {
                        await update(ref(database, `rooms/${GameState.roomCode}/players/${players[nextIndex]}`), {
                            status: 'active',
                            restTurns: 0,
                            hp: 50
                        });
                        showMessage(`${nextPlayer.name} ‡∏ü‡∏∑‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! HP = 50`, 'success');
                    } else {
                        await update(ref(database, `rooms/${GameState.roomCode}/players/${players[nextIndex]}`), {
                            restTurns: newRestTurns
                        });
                    }
                }

                nextIndex = (nextIndex + 1) % players.length;
                nextPlayer = GameState.currentRoom.players[players[nextIndex]];
            }

            await update(ref(database, `rooms/${GameState.roomCode}/game`), {
                currentTurn: nextIndex,
                turnPlayerId: players[nextIndex],
                round: nextIndex === 0 ? game.round + 1 : game.round,
                lastDice: 0
            });
        }

        function isMyTurn() {
            return GameState.currentRoom?.game?.turnPlayerId === GameState.playerId;
        }

        // Update Lobby
        function updateLobby() {
            const players = GameState.currentRoom?.players || {};
            const playerList = document.getElementById('player-list');
            const roomCodeDisplay = document.getElementById('room-code-display');
            
            roomCodeDisplay.textContent = GameState.roomCode;
            
            playerList.innerHTML = Object.entries(players).map(([id, player]) => `
                <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-3 ${id === GameState.playerId ? 'ring-2 ring-yellow-400' : ''}">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg" style="background: ${player.color}">
                        ${player.name[0].toUpperCase()}
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold">${player.name}</div>
                        ${player.isHost ? '<div class="text-xs text-yellow-400">üëë Host</div>' : ''}
                    </div>
                    <div class="text-green-400 text-2xl">‚úì</div>
                </div>
            `).join('');

            const startBtn = document.getElementById('start-btn');
            startBtn.classList.remove('hidden');
            startBtn.disabled = Object.keys(players).length < 2;
        }

        // Update Game
        function updateGame() {
            const players = GameState.currentRoom?.players || {};
            const game = GameState.currentRoom?.game || {};
            
            updateBoard(players);
            updatePlayerStats(players, game);
            updateItems(players);
            updateTurnInfo(players, game);
        }

        function updateBoard(players) {
            const board = document.getElementById('game-board');
            
            board.innerHTML = SPACES.map((space, index) => {
                const pos = index + 1;
                const playersHere = Object.entries(players).filter(([id, p]) => p.position === pos);
                
                return `
                    <div class="space-cell relative flex flex-col items-center justify-center p-2 rounded-lg transition-all ${space.hp !== 0 ? 'border-2' : ''}" 
                         data-position="${pos}"
                         style="background: ${space.color}; ${space.hp > 0 ? 'border-color: #10B981' : space.hp < 0 ? 'border-color: #EF4444' : ''}">
                        <div class="text-3xl mb-1">${space.icon}</div>
                        <div class="text-[8px] text-white/60">${pos}</div>
                        ${playersHere.length > 0 ? `
                            <div class="absolute -top-2 -right-2 flex gap-1 flex-wrap max-w-[40px]">
                                ${playersHere.map(([id, p]) => `
                                    <div class="w-4 h-4 rounded-full border-2 border-white shadow-lg" 
                                         style="background: ${p.color}"
                                         title="${p.name}"></div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updatePlayerStats(players, game) {
            const stats = document.getElementById('player-stats');
            
            stats.innerHTML = Object.entries(players).map(([id, player]) => `
                <div class="bg-gray-700 p-4 rounded-lg ${id === GameState.playerId ? 'ring-2 ring-yellow-400' : ''} ${id === game.turnPlayerId ? 'ring-2 ring-green-400' : ''}">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold relative" style="background: ${player.color}">
                            ${player.name[0].toUpperCase()}
                            ${player.shield ? '<div class="absolute -top-1 -right-1">üõ°Ô∏è</div>' : ''}
                            ${player.frozen ? '<div class="absolute -top-1 -left-1">‚ùÑÔ∏è</div>' : ''}
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm">${player.name}</div>
                            ${id === game.turnPlayerId ? '<div class="text-xs text-green-400">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>' : ''}
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>üöÄ ‡∏ä‡πà‡∏≠‡∏á</span>
                            <span class="font-bold">${player.position}/60</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-2">
                            <div class="bg-red-500 h-2 rounded-full transition-all" style="width: ${(player.hp/player.maxHp)*100}%"></div>
                        </div>
                        <div class="flex justify-between">
                            <span>‚ù§Ô∏è HP</span>
                            <span class="font-bold">${player.hp}/${player.maxHp}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>üéí ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</span>
                            <span class="font-bold">${(player.items || []).length}</span>
                        </div>
                        ${player.status === 'resting' ? `
                            <div class="text-xs text-red-400 text-center mt-2">üí§ ‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô ${player.restTurns} ‡∏ï‡∏≤</div>
                        ` : ''}
                        ${player.status === 'finished' ? `
                            <div class="text-xs text-green-400 text-center mt-2">üèÜ ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢!</div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateItems(players) {
            const myItems = document.getElementById('my-items');
            const myPlayer = players[GameState.playerId];
            
            if (myPlayer) {
                myItems.innerHTML = (myPlayer.items || []).map((item, idx) => `
                    <button 
                        onclick="useItem(${idx})"
                        class="bg-gradient-to-br ${item.effect === 'heal' || item.effect === 'move' || item.effect === 'shield' ? 'from-green-600 to-emerald-600' : 'from-red-600 to-orange-600'} hover:scale-110 p-3 rounded-xl transition-all transform shadow-lg"
                        title="${item.name}"
                        ${!isMyTurn() ? 'disabled' : ''}
                    >
                        <div class="text-3xl">${item.icon}</div>
                        <div class="text-xs mt-1 font-bold">${item.name}</div>
                    </button>
                `).join('') || '<div class="text-gray-500 text-sm col-span-4 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</div>';
            }
        }

        function updateTurnInfo(players, game) {
            const turnInfo = document.getElementById('turn-info');
            const currentPlayer = players[game.turnPlayerId];
            
            turnInfo.innerHTML = `
                <div class="text-center">
                    <div class="text-sm text-gray-400">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${game.round}</div>
                    <div class="text-xl font-bold text-yellow-400">
                        ‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á: ${currentPlayer?.name || '...'}
                    </div>
                    <div class="text-4xl mt-2" id="dice-display">
                        ${game.lastDice > 0 ? game.lastDice : 'üé≤'}
                    </div>
                </div>
            `;

            const rollBtn = document.getElementById('roll-btn');
            const myTurn = isMyTurn();
            const myPlayer = players[GameState.playerId];
            
            rollBtn.disabled = !myTurn || myPlayer?.status === 'resting' || myPlayer?.status === 'finished';
            
            if (myPlayer?.status === 'finished') {
                rollBtn.textContent = 'üèÜ ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
            } else if (myPlayer?.status === 'resting') {
                rollBtn.textContent = 'üí§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô...';
            } else if (myPlayer?.frozen) {
                rollBtn.textContent = '‚ùÑÔ∏è ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á';
            } else if (myTurn) {
                rollBtn.textContent = 'üé≤ ‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤';
            } else {
                rollBtn.textContent = '‚è≥ ‡∏£‡∏≠‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...';
            }
        }

        function showWinnerScreen() {
            const game = GameState.currentRoom.game;
            const winner = GameState.currentRoom.players[game.winner];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-12 text-center max-w-md">
                    <div class="text-6xl mb-4">üèÜ</div>
                    <h2 class="text-4xl font-bold mb-4">‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß!</h2>
                    <div class="text-2xl mb-2">${winner.name}</div>
                    <div class="text-lg text-white/80 mb-6">HP ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${winner.hp}/100</div>
                    <button onclick="leaveRoom()" class="bg-white text-purple-600 px-8 py-3 rounded-lg font-bold hover:bg-gray-100">
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Leave Room
        window.leaveRoom = async function() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á?')) {
                if (GameState.roomListener) {
                    GameState.roomListener();
                }
                
                if (GameState.roomCode && GameState.playerId) {
                    await remove(ref(database, `rooms/${GameState.roomCode}/players/${GameState.playerId}`));
                }
                
                GameState.roomCode = '';
                GameState.playerId = '';
                GameState.currentRoom = null;
                
                document.querySelectorAll('.fixed').forEach(el => el.remove());
                
                showScreen('home');
                showMessage('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info');
            }
        };

        // Show Message
        function showMessage(text, type = 'info') {
            const container = document.getElementById('message-container');
            const msg = document.createElement('div');
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };
            
            msg.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 animate-slide-in`;
            msg.textContent = text;
            
            container.appendChild(msg);
            
            setTimeout(() => {
                msg.remove();
            }, 3000);
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            showScreen('home');
        });
    </script>
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .float { animation: float 3s ease-in-out infinite; }
        
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); }
        }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }

        .space-cell {
            aspect-ratio: 1;
            min-width: 60px;
        }

        .highlight {
            animation: highlight-pulse 0.5s ease;
        }

        @keyframes highlight-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
            50% { transform: scale(1.2); box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
        }

        .screen { transition: opacity 0.3s; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-black min-h-screen text-white overflow-x-hidden">
    
    <!-- Message Container -->
    <div id="message-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm"></div>

    <!-- Home Screen -->
    <div id="home-screen" class="screen min-h-screen flex items-center justify-center p-4">
        <div class="max-w-2xl w-full">
            <div class="text-center mb-12 float">
                <h1 class="text-6xl font-bold mb-4 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                    üöÄ Space Race
                </h1>
                <p class="text-xl text-gray-300">‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏™‡∏π‡πà‡∏û‡∏•‡∏π‡πÇ‡∏ï - Board Game Edition</p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl p-8 border border-purple-500 pulse-glow">
                    <h2 class="text-2xl font-bold mb-6 text-center">üéÆ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</h2>
                    <input type="text" id="player-name-create" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" maxlength="20" class="w-full px-4 py-3 bg-gray-700 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                    <button onclick="createRoom()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 py-3 rounded-lg font-bold transition-all transform hover:scale-105">
                        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>

                <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl p-8 border border-blue-500">
                    <h2 class="text-2xl font-bold mb-6 text-center">üö™ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</h2>
                    <input type="text" id="player-name-join" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" maxlength="20" class="w-full px-4 py-3 bg-gray-700 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <input type="text" id="room-code-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á (6 ‡∏ï‡∏±‡∏ß)" maxlength="6" class="w-full px-4 py-3 bg-gray-700 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" />
                    <button onclick="joinRoom()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 py-3 rounded-lg font-bold transition-all transform hover:scale-105">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°
                    </button>
                </div>
            </div>

            <div class="mt-8 text-center text-gray-400 text-sm">
                <p>üéÆ Board Game 2-4 ‡∏Ñ‡∏ô | üéØ ‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á | üèÜ ‡∏ñ‡∏∂‡∏á‡∏û‡∏•‡∏π‡πÇ‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡∏ô‡∏∞!</p>
            </div>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby-screen" class="screen hidden min-h-screen p-8">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold mb-2">üéÆ ‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏≠</h1>
                <div class="text-3xl text-purple-400 font-mono tracking-wider" id="room-code-display">------</div>
                <p class="text-gray-400 mt-2">‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</p>
            </div>

            <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl p-8 border border-purple-500 mb-6">
                <h2 class="text-xl font-bold mb-4">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (2-4 ‡∏Ñ‡∏ô)</h2>
                <div id="player-list" class="space-y-3"></div>
            </div>

            <div class="flex gap-4">
                <button onclick="leaveRoom()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg font-bold transition-all">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á
                </button>
                <button id="start-btn" onclick="startGame()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 py-3 rounded-lg font-bold transition-all transform hover:scale-105 hidden disabled:opacity-50">
                    üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!
                </button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen hidden min-h-screen p-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl p-4 mb-4">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="text-2xl font-bold">üöÄ Space Race</div>
                    <div id="turn-info" class="flex-1"></div>
                    <button onclick="leaveRoom()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-all">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°
                    </button>
                </div>
            </div>

            <div class="grid lg:grid-cols-4 gap-4">
                <!-- Board -->
                <div class="lg:col-span-3 space-y-4">
                    <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl p-6 border border-purple-500">
                        <h2 class="text-xl font-bold mb-4">üó∫Ô∏è ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÄ‡∏Å‡∏° (60 ‡∏ä‡πà‡∏≠‡∏á)</h2>
                        <div id="game-board" class="grid grid-cols-10 gap-2 max-h-[500px] overflow-auto p-2"></div>
                    </div>

                    <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl p-6 border border-blue-500">
                        <h2 class="text-xl font-bold mb-4">üéí ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                        <div id="my-items" class="grid grid-cols-4 md:grid-cols-6 gap-3"></div>
                    </div>

                    <div class="text-center">
                        <button id="roll-btn" onclick="rollDice()" class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 px-12 py-4 rounded-lg font-bold text-xl transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            üé≤ ‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤
                        </button>
                    </div>
                </div>

                <!-- Player Stats -->
                <div class="lg:col-span-1">
                    <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl p-6 border border-blue-500 sticky top-4">
                        <h2 class="text-xl font-bold mb-4">üìä ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
                        <div id="player-stats" class="space-y-3 max-h-[600px] overflow-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
